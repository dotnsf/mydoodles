<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<title><%= doodle.title %></title>
<script type="text/javascript" src="//code.jquery.com/jquery-2.2.4.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<link href="//use.fontawesome.com/releases/v5.8.1/css/all.css" rel="stylesheet"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="shortcut icon" href="/icon.png" type="image/png"/>
<link rel="icon" href="/icon.png" type="image/png"/>
<link rel="apple-touch-icon" href="/icon.png"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="My Doodles"/>

<!-- // OGP tags -->
<meta property="og:title" content="My Doodles"/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://mydoodles.mybluemix.net/doodle/<%= id %>"/>
<meta property="og:image" content="https://mydoodles.mybluemix.net/attachment/<%= id %>"/>
<meta property="og:site_name" content="My Doodles - <%= __('common.appdesc') %>"/>
<meta property="og:description" content="My Doodles : <%= doodle.title %>"/>
<!-- OGP tags // -->

<!-- // Twitter Card -->
<meta property="twitter:card" content="summary"/>
<meta property="twitter:site" content="@dotnsf"/>
<meta property="twitter:creator" content="@dotnsf"/>
<meta property="twitter:url" content="https://mydoodles.mybluemix.net/doodle/<%= id %>"/>
<meta property="twitter:image" content="https://mydoodles.mybluemix.net/attachment/<%= id %>"/>
<meta property="twitter:title" content="My Doodles - <%= __('common.appdesc') %>"/>
<meta property="twitter:description" content="My Doodles : <%= doodle.title %>"/>
<!-- Twitter Card // -->

<style type="text/css">
html, body{
  text-align: center;
  background-color: #fafafa;
  font-size: 20px;
  color: #333;
}
.hide{
  display: none;
}
</style>
</head>
<body>
  <!-- //navi -->
  <nav class="navbar navbar-expand-lg">
    <div class="navbar-header">
      <a class="btn btn-primary" href="/"><%= __('common.wanttotry') %></a>
    </div>

    <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">
        </ul>
        <ul class="nav navbar-nav" id="share_buttons">   
      	  <li class="nav-item">
            <!-- twitter -->
            <a class="nav-link" id="share_twitter" title="<%= __('common.doodle.share_twitter.title') %>" href="https://twitter.com/share?url=https://mydoodles.mybluemix.net/doodle/<%= id %>&text=%20<%= doodle.title %>&hashtags=mydoodles" target="_blank">
              <img src="/share_twitter.png"/>
            </a>
          </li>

      	  <li class="nav-item">
            <!-- facebook -->
            <a class="nav-link" id="share_facebook" title="<%= __('common.doodle.share_facebook.title') %>" href="https://www.facebook.com/share.php?u=https://mydoodles.mybluemix.net/doodle/<%= id %>" onclick="window.open(this.href, 'FBwindow', 'width=650,height=450,menubar=no,toolbar=no,scrollbars=yes'); return false;">
              <img src="/share_facebook.png"/>
            </a>
          </li>

      	  <li class="nav-item">
            <!-- line -->
            <a class="nav-link" id="share_line" title="<%= __('common.doodle.share_line.title') %>" href="https://social-plugins.line.me/lineit/share?url=https://mydoodles.mybluemix.net/doodle/<%= id %>" onclick="window.open(this.href, 'Linewindow', 'width=650,height=450,menubar=no,toolbar=no,scrollbars=yes'); return false;">
              <img src="/share_line.png"/>
            </a>
          </li>

      	  <li class="nav-item">
            <!-- QRCode -->
            <!--
            <a class="nav-link" id="share_qrcode" title="" href="#">
              <button class="btn btn-secondary btn-xs py-0" onClick="qrCode('<%= doodle._id %>');"><i class="fas fa-qrcode"></i></button>
            </a>
            -->
          </li>
        </ul>
    </div>
  </nav>
  <!-- navi// -->


<div class="container" id="dummy" style="position: relative; top: 20px; text-align: right">
</div>

<div class="container" id="doodle" style="position: relative: top: 20px;">
  <img src="/attachment/<%= id %>" title="<%= doodle.title %>" width="80%"/>
</div>

<div class="container" id="title" style="position: relative; top: 20px;">
  <h3><%= doodle.title %></h3>
</div>

<div class="container" id="dt" style="position: relative; top: 20px;">
  <div id="datetime" style="text-align: right">
  </div>
</div>

<div class="modal bd-example-modal-lg fade" id="qrcodeModal" tabindex="-1" role="dialog" aria-labbelledby="qrcodeModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="qrcodeModalLabel"><%= doodle.title %></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="qrcodemodal-body">
        <img id="qrcode_img"/>
      </div>
      <div class="modal-footer btn-center">
      </div>
    </div>
  </div>
</div>

<div class="hide">
  <canvas id="canvas" width="32" height="32"></canvas>
</div>

<script>
$(function(){
  var ts = parseInt( '<%= doodle.timestamp %>' );
  var dt = timestamp2datetime( ts );
  $('#datetime').html( dt );

  var image_uuid = '<%= doodle.uuid %>';
  var your_uuid = getUUID();
  if( your_uuid && your_uuid == image_uuid ){
    //var edit_btn = '<button class="btn btn-warning btn-xs" onClick="editDoodle(\'<%= doodle._id %>\');"><%= __('common.doodle.edit') %></button>';
    //$('#dummy').html( edit_btn );
    var edit_button = '<li class="nav-item">'
      + '<a class="nav-link" href="#">'
      + '<button class="btn btn-warning btn-xs py-0" onClick="editDoodle(\'<%= doodle._id %>\');"><i class="fas fa-edit"></i></button>'
      + '</a>'
      + '</li>';
    $('#share_buttons').append( edit_button );
  }

  //. #8
  var img = new Image();
  img.src = '/attachment/<%= id %>';
  img.onload = () => {
    var canvas = document.getElementById( 'canvas' );
    if( !canvas || !canvas.getContext ){
      return false;
    }
    var ctx = canvas.getContext( '2d' );
    ctx.drawImage( img, 0, 0, canvas.width, canvas.height );
  };
});

function editDoodle( id ){
  location.href = '/?id=' + id;
}

function timestamp2datetime( ts ){
  if( ts ){
    var dt = new Date( ts );
    var yyyy = dt.getFullYear();
    var mm = dt.getMonth() + 1;
    var dd = dt.getDate();
    var hh = dt.getHours();
    var nn = dt.getMinutes();
    var ss = dt.getSeconds();
    var datetime = yyyy + '-' + ( mm < 10 ? '0' : '' ) + mm + '-' + ( dd < 10 ? '0' : '' ) + dd
      + ' ' + ( hh < 10 ? '0' : '' ) + hh + ':' + ( nn < 10 ? '0' : '' ) + nn + ':' + ( ss < 10 ? '0' : '' ) + ss;
    return datetime;
  }else{
    return "";
  }
}

function getUUID(){
  //. Cookie の値を調べる
  var did = null;
  cookies = document.cookie.split(";");
  for( var i = 0; i < cookies.length; i ++ ){
    var str = cookies[i].split("=");
    if( unescape( str[0] ) == " deviceid" ){
      did = unescape( unescape( str[1] ) );
    }
  }

  return did;
}

function qrCode( id ){
  //console.log( 'qrCode: id = ' + id );

  var canvas = document.getElementById( 'canvas' );
  if( !canvas || !canvas.getContext ){
    return false;
  }
  var ctx = canvas.getContext( '2d' );

  //. タイトル
  var title = 'My Work'; //'<%= doodle.title %>';

  //. 作者
  var author = 'My Doodles';

  //. Town
  var town = 'My Town';

  //. カラーパレット
  var color_palette = [
    149,  //. transparent #cccccc
    159,  //. black       #000000
    145,  //. white       #ffffff
    5,    //. red         #ff0000
    86,   //. blue        #0000ff
    95,   //. green       #00ff00
    68,   //. yellow      #ffff00
    122,  //. cyan        #00ffff
    41,   //. magenta     #ff00ff
    153,  //. gray        #808080
    47,   //. pink        #ef8f9c
    30,   //. beige       #ead2ad
    59,   //. brown       #7c6035
    111,  //. dummy
    112   //. dummy
  ];

  //. 画像データ
  var imgdata = [];
  var imagedata = ctx.getImageData( 0, 0, 32, 32 );
  for( var i = 0; i < imagedata.height; i ++ ){
    for( var j = 0; j < imagedata.width; j += 2 ){
      var idx = ( j + i * imagedata.width ) * 4;

  		var r1 = imagedata.data[idx];
  		var g1 = imagedata.data[idx+1];
      var b1 = imagedata.data[idx+2];
      var color_index1 = getColorIndex( r1, g1, b1 );

  		var r2 = imagedata.data[idx+4];
  		var g2 = imagedata.data[idx+5];
      var b2 = imagedata.data[idx+6];
      var color_index2 = getColorIndex( r2, g2, b2 );

      var idx = color_index2 * 16 + color_index1;
      imgdata.push( idx );
    }
  }

  if( color_palette && imgdata ){
    var data = [];

    //. Title
    for( var i = 0; i < title.length || i < 21; i ++ ){
      if( i < 21 ){
        if( i < title.length ){
          var c = title.charCodeAt( i );
          data.push( c );
        }else{
          data.push( 0 );
        }
        data.push( 0 );
      }
    }

    //. *1, *2
    data.push( 0 );
    data.push( 0 );

    //. Author
    for( var i = 0; i < author.length || i < 9; i ++ ){
      if( i < 9 ){
        if( i < author.length ){
          var c = author.charCodeAt( i );
          data.push( c );
        }else{
          data.push( 0 );
        }
        data.push( 0 );
      }
    }

    //. *12, *13, *3, *4
    data.push( 0 );
    data.push( 0 );
    data.push( 0 );
    data.push( 0 );

    //. Town
    for( var i = 0; i < town.length || i < 9; i ++ ){
      if( i < 9 ){
        if( i < town.length ){
          var c = town.charCodeAt( i );
          data.push( c );
        }else{
          data.push( 0 );
        }
        data.push( 0 );
      }
    }

    //. *14, *15, *5, *6
    data.push( 0 );
    data.push( 0 );
    data.push( 0 );
    data.push( 0 );

    //. Color Pallete
    for( var i = 0; i < color_palette.length; i ++ ){
      data.push( color_palette[i] );
    }

    //. *7, *8, *9, *10, *11
    data.push( 0 );
    data.push( 10 );
    data.push( 9 );
    data.push( 0 );
    data.push( 0 );

    //. Palette data
    for( var i = 0; i < imgdata.length; i ++ ){
      data.push( imgdata[i] );
    }

    /* モード１で作られてしまう
    //. https://www.npmjs.com/package/qrcode#api
    QRCode.toCanvas( document.getElementById( 'qrcode' ), data, function( err ){
      if( err ){
        console.log( err );
      }else{
        $('#qrcodeModal').modal();
      }
    });
    */

    //. 結果を blob で受け取るため、XMLHttpRequest で送信
    //. https://qiita.com/Yarimizu14/items/f56123c738f12ad1844a
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(){
      if( this.readyState == 4 && this.status == 200 ){
        var data = this.response;
        var reader = new FileReader();
        reader.onloadend = function(){
          var qrcode_img = document.getElementById( 'qrcode_img' );
          qrcode_img.src = reader.result;
          $('#qrcodeModal').modal();
        }
        reader.readAsDataURL( data );
      }
    }
    xhr.open( 'POST', '/qrcode' );
    xhr.responseType = 'blob';
    xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
    xhr.send( 'data=' + data );
  }
}

function getColorIndex( rr, gg, bb ){
  var idx = 0;

  /* この中のどの色に近いか、を調べて、インデックスを返す
  //. カラーパレット
  var color_palette = [
    149,  //. transparent #cccccc
    159,  //. black       #000000
    145,  //. white       #ffffff
    5,    //. red         #ff0000
    86,   //. blue        #0000ff
    95,   //. green       #00ff00
    68,   //. yellow      #ffff00
    122,  //. cyan        #00ffff
    41,   //. magenta     #ff00ff
    153,  //. gray        #808080
    47,   //. pink        #ef8f9c
    30,   //. beige       #ead2ad
    59,   //. brown       #7c6035
    111,  //. dummy
    112   //. dummy
  ];
  */
  /*
  		if( rr && gg && bb ){
  			col_type = 7;
  		}else if( !rr && gg && bb ){
  			col_type = 3;
  		}else if( rr && !gg && bb ){
  			col_type = 5;
  		}else if( rr && gg && !bb ){
  			col_type = 6;
  		}else if( !rr && !gg && bb ){
  			col_type = 1;
  		}else if( !rr && gg && !bb ){
  			col_type = 2;
  		}else if( rr && !gg && !bb ){
  			col_type = 4;
  		}else if( !rr && !gg && !bb ){
  			col_type = 0;
      }
      */
  idx = Math.floor( Math.random() * 13 );
  return idx;
}
</script>
</body>
</html>
